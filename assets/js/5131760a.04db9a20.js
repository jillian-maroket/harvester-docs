"use strict";(self.webpackChunkharvester_docs=self.webpackChunkharvester_docs||[]).push([[59978],{3905:(e,t,r)=>{r.d(t,{Zo:()=>u,kt:()=>g});var a=r(67294);function n(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function o(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,a)}return r}function i(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?o(Object(r),!0).forEach((function(t){n(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function l(e,t){if(null==e)return{};var r,a,n=function(e,t){if(null==e)return{};var r,a,n={},o=Object.keys(e);for(a=0;a<o.length;a++)r=o[a],t.indexOf(r)>=0||(n[r]=e[r]);return n}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)r=o[a],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(n[r]=e[r])}return n}var p=a.createContext({}),s=function(e){var t=a.useContext(p),r=t;return e&&(r="function"==typeof e?e(t):i(i({},t),e)),r},u=function(e){var t=s(e.components);return a.createElement(p.Provider,{value:t},e.children)},c="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var r=e.components,n=e.mdxType,o=e.originalType,p=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),c=s(r),m=n,g=c["".concat(p,".").concat(m)]||c[m]||d[m]||o;return r?a.createElement(g,i(i({ref:t},u),{},{components:r})):a.createElement(g,i({ref:t},u))}));function g(e,t){var r=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var o=r.length,i=new Array(o);i[0]=m;var l={};for(var p in t)hasOwnProperty.call(t,p)&&(l[p]=t[p]);l.originalType=e,l[c]="string"==typeof e?e:n,i[1]=l;for(var s=2;s<o;s++)i[s]=r[s];return a.createElement.apply(null,i)}return a.createElement.apply(null,r)}m.displayName="MDXCreateElement"},85061:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>c,frontMatter:()=>n,metadata:()=>i,toc:()=>p});r(67294);var a=r(3905);const n={sidebar_position:4,sidebar_label:"Upgrade from v1.2.2/v1.3.0 to v1.3.1",title:"Upgrade from v1.2.2/v1.3.0 to v1.3.1"},o=void 0,i={unversionedId:"upgrade/v1-2-2-to-v1-3-1",id:"version-v1.3/upgrade/v1-2-2-to-v1-3-1",title:"Upgrade from v1.2.2/v1.3.0 to v1.3.1",description:"General information",source:"@site/versioned_docs/version-v1.3/upgrade/v1-2-2-to-v1-3-1.md",sourceDirName:"upgrade",slug:"/upgrade/v1-2-2-to-v1-3-1",permalink:"/v1.3/upgrade/v1-2-2-to-v1-3-1",draft:!1,editUrl:"https://github.com/harvester/docs/edit/main/versioned_docs/version-v1.3/upgrade/v1-2-2-to-v1-3-1.md",tags:[],version:"v1.3",lastUpdatedAt:1732780556,formattedLastUpdatedAt:"Nov 28, 2024",sidebarPosition:4,frontMatter:{sidebar_position:4,sidebar_label:"Upgrade from v1.2.2/v1.3.0 to v1.3.1",title:"Upgrade from v1.2.2/v1.3.0 to v1.3.1"},sidebar:"api",previous:{title:"Upgrade from v1.3.1 to v1.3.2",permalink:"/v1.3/upgrade/v1-3-1-to-v1-3-2"},next:{title:"Upgrade from v1.2.1 to v1.2.2",permalink:"/v1.3/upgrade/v1-2-1-to-v1-2-2"}},l={},p=[{value:"General information",id:"general-information",level:2},{value:"Known issues",id:"known-issues",level:2},{value:"1. Cluster upgrade stuck after the first node is upgraded",id:"1-cluster-upgrade-stuck-after-the-first-node-is-upgraded",level:3},{value:"2. Automatic image cleanup is not functioning",id:"2-automatic-image-cleanup-is-not-functioning",level:3}],s={toc:p},u="wrapper";function c({components:e,...t}){return(0,a.kt)(u,{...s,...t,components:e,mdxType:"MDXLayout"},(0,a.kt)("head",null,(0,a.kt)("link",{rel:"canonical",href:"https://docs.harvesterhci.io/v1.3/upgrade/v1-2-2-to-v1-3-1"})),(0,a.kt)("h2",{id:"general-information"},"General information"),(0,a.kt)("p",null,"An ",(0,a.kt)("strong",{parentName:"p"},"Upgrade")," button appears on the ",(0,a.kt)("strong",{parentName:"p"},"Dashboard")," screen whenever a new Harvester version that you can upgrade to becomes available. For more information, see ",(0,a.kt)("a",{parentName:"p",href:"/v1.3/upgrade/index#start-an-upgrade"},"Start an upgrade"),"."),(0,a.kt)("p",null,"For air-gapped environments, see ",(0,a.kt)("a",{parentName:"p",href:"/v1.3/upgrade/index#prepare-an-air-gapped-upgrade"},"Prepare an air-gapped upgrade"),"."),(0,a.kt)("h2",{id:"known-issues"},"Known issues"),(0,a.kt)("hr",null),(0,a.kt)("h3",{id:"1-cluster-upgrade-stuck-after-the-first-node-is-upgraded"},"1. Cluster upgrade stuck after the first node is upgraded"),(0,a.kt)("admonition",{type:"tip"},(0,a.kt)("p",{parentName:"admonition"},"To prevent this issue from occurring, label the ",(0,a.kt)("inlineCode",{parentName:"p"},"local-kubeconfig")," secret before starting the upgrade process.\n",(0,a.kt)("inlineCode",{parentName:"p"},"kubectl label secret local-kubeconfig -n fleet-local cluster.x-k8s.io/cluster-name=local"))),(0,a.kt)("p",null,"When upgrading a Harvester cluster from v1.2.2 or v1.3.0 to v1.3.1, the upgrade process becomes stuck after the first node is upgraded."),(0,a.kt)("p",null,"Example:"),(0,a.kt)("p",null,(0,a.kt)("img",{src:r(3330).Z,width:"565",height:"800"})),(0,a.kt)("p",null,"To resolve this issue, perform the following steps:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Identify the cluster status:"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre"},"kubectl get clusters.provisioning.cattle.io local -n fleet-local -o yaml\n")),(0,a.kt)("p",{parentName:"li"},"Example output:"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre"},"...\n  - lastUpdateTime: \"2024-06-18T23:37:39Z\"\n    message: 'configuring bootstrap node(s) custom-9cb22ccf7984: waiting for kubelet\n      to update'\n    reason: Waiting\n    status: Unknown\n    type: Updated\n  - lastUpdateTime: \"2024-06-18T23:37:39Z\"\n    message: 'configuring bootstrap node(s) custom-9cb22ccf7984: waiting for kubelet\n      to update'\n    reason: Waiting\n    status: Unknown\n    type: Provisioned\n")),(0,a.kt)("p",{parentName:"li"},"If the output includes the message ",(0,a.kt)("inlineCode",{parentName:"p"},"waiting for kubelet"),", continue to the next step.")),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Check the ",(0,a.kt)("inlineCode",{parentName:"p"},"capi-controller-manager")," pod's logs:"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre"},"kubectl logs -n cattle-provisioning-capi-system deployment/capi-controller-manager\n")),(0,a.kt)("p",{parentName:"li"},"If the output is similar to the following example, the issue likely exists in the cluster."),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre"},"2024-06-19T08:54:22.407423986Z W0619 08:54:22.407257       1 reflector.go:424] k8s.io/client-go@v0.26.1/tools/cache/reflector.go:169: failed to list *v1.Node: Unauthorized\n2024-06-19T08:54:22.407470069Z E0619 08:54:22.407283       1 reflector.go:140] k8s.io/client-go@v0.26.1/tools/cache/reflector.go:169: Failed to watch *v1.Node: failed to list *v1.Node: Unauthorized\n2024-06-19T08:55:05.153396619Z W0619 08:55:05.153190       1 reflector.go:424] k8s.io/client-go@v0.26.1/tools/cache/reflector.go:169: failed to list *v1.Node: Unauthorized\n2024-06-19T08:55:05.153438978Z E0619 08:55:05.153217       1 reflector.go:140] k8s.io/client-go@v0.26.1/tools/cache/reflector.go:169: Failed to watch *v1.Node: failed to list *v1.Node: Unauthorized\n"))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Apply the following workaround to resume the upgrade:"),(0,a.kt)("p",{parentName:"li"},"Kill and restart the ",(0,a.kt)("inlineCode",{parentName:"p"},"capi-controller-manager")," pod."),(0,a.kt)("p",{parentName:"li"},"Example:"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre"},"kubectl rollout restart deployment/capi-controller-manager -n cattle-provisioning-capi-system\n")))),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Related issue:",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://github.com/harvester/harvester/issues/6041"},"[BUG] Upgrade v1.2.2->v1.3.1 stuck at Waiting for kubelet to update, even the node has been updated"))))),(0,a.kt)("hr",null),(0,a.kt)("h3",{id:"2-automatic-image-cleanup-is-not-functioning"},"2. Automatic image cleanup is not functioning"),(0,a.kt)("p",null,"Because the published Harvester ISO contains an incomplete image list, automatic image cleanup cannot be performed during an upgrade from v1.2.2 to v1.3.1. This issue does not block the upgrade, and you can use ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/harvester/upgrade-helpers/blob/main/bin/harv-purge-images.sh"},"this script")," to manually clean up container images after the upgrade is completed. For more information, see ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/harvester/harvester/issues/6620"},"issue #6620"),"."),(0,a.kt)("hr",null))}c.isMDXComponent=!0},3330:(e,t,r)=>{r.d(t,{Z:()=>a});const a=r.p+"assets/images/6041-stuck-on-first-node-cf6574bdd3b56ed67814dd089aaaa393.png"}}]);